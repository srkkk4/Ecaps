# SG 函数

<br>

#### - SG 函数

回顾 Nim 游戏, 我们用数值给出了一个关于游戏状态局面的描述, 下面给出一个普适的游戏模型, 并用一个函数描述所有的状态 : 

> 给定一个大小为 $n$ 的 DAG ( 从 $1$ ~ $n$ 标号 ), 满足只有 $1$ 号点入度为 $0$
> 
> 一开始在 $1$ 号点上放一个棋子, $A, B$ 轮流移动棋子, 每次可以将棋子沿当前所在点的一条出边走一步, 不能操作者输, 问先手必胜还是必败

仿照 Nim 游戏的思想, 我们用一个数值描述一个状态, 假设当前点在 $x$ 点, 那么我们设此时局面的状态为 $\text{sg}(x)$

同样地, 我们设先手必败则 $\text{sg}(x) = 0$, 否则 $\text{sg}(x) \in \N_+$

对于这个问题, 我们可以仿照 Nim 游戏给出的基本事实, 不妨设 $\text{sg} (x) \in \{0, 1\}$, 那么有 

$$
\text{sg}(x) = \text{not} (\text{and}_{(x, v) \in E}\ \text{sg}(v))
$$

对于出度为 $0$ 的点, 有 $\text{sg} = 0$

不难证明其对于单个游戏的正确性

<br>

#### - SG 定理 与 Nim 和

考虑下多个 DAG 的情况, 每个 DAG 上都放有棋子, 每次可以选择一个棋盘上的棋子进行移动, 不能操作者输, 问先手必胜还是必败

对于多个棋盘, 我们显然不能按照上面的方法构造 sg 函数, 因为对于一个棋盘, 结束完操作后, 先后手顺序可能发生改变, 我们需要构造更为强大的 sg 函数满足我们的需求

定义运算 $\text{mex}$ 作用于任意一个非负整数集合 $S$, 设 $w = \text{mex}(S)$则 $w \not \in S, \forall i \in [0, w),i \in S$, 大白话就是 $\text{mex} (S)$ 表示 $S$ 中没有出现的最小非负整数

我们重新归纳定义 sg 的值 : 

$$
\text{sg}(x) = \text{mex}_{(x, v)\in E} \text{ sg} (v)
$$

对于出度为 $0$ 的点不难得到 $\text{sg} = 0$

对于单个游戏的正确性显然, 考虑对于多个游戏, 注意 $\text{mex}$ 的性质就不难发现, 假设对于其中一个游戏的 $\text{sg} = w$, 那么我们操作一步就可以把 sg 变成 $[0, w)$ 中的任何一个数, 这与 Nim 游戏的定义一致 !

所以我们不难发现, 总局面的 sg 分局面的 $\text{sg}$ 异或和, 即 $\text{sg}_{\text{all}} = \bigoplus \text{sg}_i$ ( 这个东西简称 " Nim 和 " ), 那么根据 sg 的定义就可以判断总局面是先手必胜还是先手必败了

<br>

#### - 泛化 Nim 和

上面的核心总结就是, 总局面等于分局面的 Nim 和, 其中分局面要保证局面之间独立 ( 所谓独立就是指单步操作不能影响到其它局面的 sg 值 ), 这个东西可以拓展, 就是所谓的泛化 Nim 和, 为了方便, 下面表述中 " 局面 " 可能被称为 " 游戏 " / " 棋盘 "

泛化 Nim 游戏是在普通 Nim 游戏的基础上, 把操作限制由每次只能选 $1$ 堆, 变为每次可以选择 $k$ 堆进行操作, 问先手必胜还是先手必败

这里我并不想直接说结论来归纳证明, 而是通过一些思考来引出结论

考虑我们的证明, 实际上就是要能够使 sg 在 $0$ 与非 $0$ 之间总能进行转换, 且 $0$ 转非 $0$ 存在必然性

换一种比较感性的描述就是, 当 sg 为 $0$ 时, 操作要尽可能无效, 当 $\text{sg}$ 非 $0$ 时, 操作空间要尽可能地大

另一个感性理解就是, 我们的要尽可能地在 **二进制** 上研究, 因为二进制的 01 是易于改变的, 与上面的描述是比较接近的, 并且 01 具有二义性

拆位考虑 ( 我们对每一位称为 " 层 " ), 改变 $k$ 个石子堆的个数, 实际上对于一层最多改变 $k$ 个 01 的状态

但为了使得下面的描述更加自然, 我们不妨先预测一下最终的式子, 由于普通 Nim 一定是属于泛化 Nim 的一种, 那么这二者之间一定具有相似性, 由上面的分析, 要尽可能地往二进制上考虑, 那么其实我们就是要泛化 $\oplus$, 当然, 这种表述可能过于绝对, 但是回归原式子, 其实我们并不太可能在原式上面加上其它的二进制运算 ( 但另一种可能是作者已知道结论, 思维被局限了 )

一方面, 考虑到原本的 $\oplus$ 实际上是对于每一位加和后, 对 $2$ 取模

另一方面, 对于每一层, 由于每次只改变 $k$ 位, 从 $x$ ( $x$ 表示这一层 $1$ 的个数 ) 开始变化的话, 最多变到 $[x - k, x + k]$, 而由于至少去掉一个石子, 所以必然有一层的 $1$ 的个数发生改变

综上, 我们可以联想到泛化的 Nim 和为 : 

考虑所有的二进制位, 如果每一位上 $1$ 的个数为 $k + 1$ 的倍数, 那么先手必败, 否则先手必胜

一方面, 由于上面的论证, 容易得到由先手必败局面转为必胜局面是必然的

另一方面, 对于任意 $x \in [1, k]$, 它可以转变为 $[x - k, x + k]$, 这段区间必然包含了 $0$, 所以总是存在一种方案将必胜状态转为必败状态, 详细的证明依然考虑从高位到低位的任意变化即可 ( 注意对于某一个数, 把最高位置为 $0$ 后, 后面的位置可以随意变化 )

> 一个比较舒服的思维方式是, 从高位到低位考虑, 假设当前位置 $1$ 的个数对 $k + 1$ 取模后为 $x \in [0, k]$, 那么强制把其中 $x$ 个地方的 $1$ 改成 $0$, 并且将这些数后面的位置全部置为 $1$, 并且相当于获得了 $x$ 个 " 自由元 "
> 
> 假设现在有 $w$ 个自由元, 当前位置 $1$ 的个数 ( 注意这个统计了被我们从 $0$ 变为 $1$ 的个数 ) 对 $k + 1$ 取模后为 $x$, 若 $w \geqslant x$, 则直接用 $x$ 个自由元消掉即可, 否则还需要把 $x - w$ 个位置的 $1$ 强制改成 $0$, 想象当把自由元的这一位 $1$ 全部置 $0$ 后, $x \leftarrow x - w$, 并且此时, 非自由元关于这一位一定有不少于 $x - w$ 的 $1$, 那么直接选 $x - w$ 个这一位为 $1$ 的非自由元消掉即可, 并把它们算作新的自由元

但是注意泛化 Nim 和并不能嵌套, 也就是说, 我们对于整个游戏并没有求出一个具体的 sg 值, 它只能用来分析胜负, 更具体而言, 我们求出的其实是一组数

> 作者试图分析在 $k + 1$ 进制下该问题是否可做, 经过实践发现不太可能, 下面给出一组数据
> 
> ```
> n = 4
> k = 2
> ai = { 3, 1, 3, 2 }
> ```

<br>

#### - 总结

总而言之, $\text{SG}$ 用于研究单个游戏的状态, Nim 和则用于统一多个游戏, 二者相辅相成

<br>

#### - 参考

[csdn blog1]([博弈论 SG函数_Strangedbly-CSDN博客_sg函数](https://blog.csdn.net/strangedbly/article/details/51137432))

[csdn blog2](https://blog.csdn.net/myjs999/article/details/81316163)

[2009 集训队论文 " 从“k倍动态减法游戏”出发探究一类组合游戏问题 - 曹钦翔 "]
